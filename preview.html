<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RESQUE Collector - Preview</title>

    <link rel="stylesheet" href="./styles.css" />
</head>

<body>
    <script src="//unpkg.com/alpinejs" defer></script>

    <script>
        const getPacks = async () => {
            const response = await fetch('./packs/archive/info.json');
            const data = await response.json();
            return data;
        }

        const getPack = async (filename) => {
            if (!filename) {
                return {};
            }

            const response = await fetch(`./packs/${filename}.json`);
            const data = await response.json();
            return data;
        }

        document.addEventListener('alpine:init', () => {
            Alpine.store('packs', getPacks());

            Alpine.store('pack', {});

            Alpine.store('filter', '');

            Alpine.effect(() => {
                const pack = Alpine.store('pack');

                console.log(pack.title)
            });

        });

        const evaluateFilter = (filter, elemId) => {
            if (!filter) {
                return true;
            }

            // Check if elemId starts with one of the comma separated values in filter
            return filter.split(',').some(f => elemId.startsWith(f.trim()));
        }

        const preprocessText = text => {
            return text
                .replaceAll(/meta\$([a-zA-Z0-9_]+)/g, (match, variable) => variable)
                .replaceAll(/global\$([a-zA-Z0-9_]+)@([a-zA-Z0-9_]+)/g, (match, variable, type) => {
                    return '...';
                })
                .replaceAll(/config\$([a-zA-Z0-9_]+)/g, (match, variable) => {
                    return '...';
                })
                .replaceAll(/config\$([a-zA-Z0-9_]+)@([a-zA-Z0-9_]+)/g, (match, variable, type) => {
                    return '...';
                })
                .replaceAll(/\$([a-zA-Z0-9_]+?)@([a-zA-Z0-9_]+)/g, (match, variable, type) => {
                    return '...';
                })
                .replaceAll(/\$([a-zA-Z0-9_]+)/g, (match, variable) => {
                    return variable;
                });
        }

    </script>

    <div x-data="{selectedPack: ''}" x-effect="getPack(selectedPack).then(d => $store.pack = d)">
        <div class="no-print" style="padding: 16px; border-bottom: 1px solid lightgray;">
            <select x-model="selectedPack" style="width: fit-content; display: inline-block; margin-bottom: 0;">
                <option value="" selected disabled hidden>Choose pack for preview</option>

                <option value="core-meta">core-meta</option>
                <option value="core-pubs">core-pubs</option>
                <option value="core-data">core-data</option>
                <option value="core-software">core-software</option>

                <template x-for="pack in $store.packs" :key="pack.type + '_' + pack.version">
                    <option x-text="pack.type + ', v' + pack.version + ' (archived)'"
                        :value="'archive/' + pack.type + '-' + pack.version.replaceAll('.', '_')"></option>
                </template>
            </select>

            <input x-model="$store.filter" type="text" placeholder="Filter"
                style="width: 500px; display: inline-block; margin-bottom: 0;"></input>

        </div>

        <div>
            <div id="formview">
                <h2 x-show="!$store.pack.title" style="color: gray; font-style: italic; text-align: center;">
                    Choose a pack to see indicators.
                </h2>

                <h2 style="text-align: center;" x-show="$store.pack.title" x-text="'RESQUE: ' + $store.pack.title"></h2>

                <template x-for="(elem, index) in $store.pack.elements" :key="index">
                    <div x-show="evaluateFilter($store.filter, elem.id)">
                        <p x-show="elem.title" x-html="preprocessText(elem.title)" style="font-weight: bold;"></p>

                        <template x-if="elem.type === 'separator'">
                            <hr style="height: 3px; border:none; color: #333; background-color: #333;" />
                        </template>

                        <template x-if="elem.type === 'info'">
                            <p x-html="preprocessText(elem.text)"></p>
                        </template>

                        <template x-if="elem.type === 'text'">
                            <input type="text" :placeholder="elem.title || ''" />
                        </template>

                        <template x-if="elem.type === 'textbox'">
                            <div>
                                <div class="textbox" contenteditable :placeholder="elem.title || ''"></div>

                                <template x-if="!!elem.maxwords">
                                    <p class="wordcount"
                                        :class="(('').match(/\S+/g) ?? []).length > elem.maxwords ? 'wordcount-warning' : ''"
                                        x-text="`${(('').match(/\S+/g) ?? []).length} / ${elem.maxwords} words`">
                                    </p>
                                </template>
                            </div>
                        </template>

                        <template x-if="elem.type === 'number'">
                            <input type="text" :placeholder="elem.title || ''" />
                        </template>

                        <template x-if="elem.type === 'date'">
                            <input type="date" :placeholder="elem.title || ''" />
                        </template>

                        <template x-if="elem.type === 'dropdown'">
                            <select>
                                <template x-for="option in elem.options" :key="option.id">
                                    <p x-text="option.text"></p>
                                    <option x-html="option.text" :value="option.id"></option>
                                </template>
                            </select>
                        </template>

                        <template x-if="elem.type === 'radio'">
                            <div :class="elem.alignment ? 'alignment-' + elem.alignment : 'alignment-vertical'">
                                <template x-for="option in elem.options" :key="option.id">
                                    <label :for="elem.id + '_' + option.id">
                                        <input type="radio" :id="elem.id + '_' + option.id" :value="option.id" />
                                        <span x-html="option.text"></span>
                                    </label>
                                </template>
                            </div>
                        </template>

                        <template x-if="elem.type === 'checkbox'">
                            <template x-for="option in elem.options" :key="option.id">
                                <label :for="elem.id + '_' + option.id">
                                    <input type="checkbox" :id="elem.id + '_' + option.id" />
                                    <span x-html="option.text"></span>
                                </label>
                            </template>
                        </template>
                    </div>
                </template>
            </div>
        </div>

    </div>

    <style>
        .formview {
            overflow: auto;
        }

        body {
            overflow: auto;
        }

        @media print {
            .no-print,
            .no-print * {
                display: none !important;
            }
        }
    </style>
</body>

</html>