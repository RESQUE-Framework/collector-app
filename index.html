<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RESQUE</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="indicator-styles.css" />

    <!-- Matomo -->
    <script>
        var _paq = window._paq = window._paq || [];
        /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function () {
            var u = "//tellmi.psy.lmu.de/matomo/";
            _paq.push(['setTrackerUrl', u + 'matomo.php']);
            _paq.push(['setSiteId', '6']);
            var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
            g.async = true; g.src = u + 'matomo.js'; s.parentNode.insertBefore(g, s);
        })();
    </script>
    <!-- End Matomo Code -->


    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src=" https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/@alpinejs/sort@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script type="module">
        import { getDefaultValues } from "./utils/packutils.js";
        import { getDepths } from "./utils/prefixtree.js";
        import { score, scoreAll, generateScoringRules } from "./utils/score.js";
        import { renderScoreChart } from "./utils/charts.js";
        import { fetchAuthorByORCID, fetchPapersByORCID } from "./utils/orcid.js";
        import { fetchInformationUsingDOI } from "./utils/doi.js";
        import { renameOldKeys } from "./utils/keyalias.js";

        window.getDefaultValues = getDefaultValues;
        window.getDepths = getDepths;
        window.score = score;
        window.scoreAll = scoreAll;
        window.generateScoringRules = generateScoringRules;
        window.renderScoreChart = renderScoreChart;
        window.fetchAuthorByORCID = fetchAuthorByORCID;
        window.fetchPapersByORCID = fetchPapersByORCID;
        window.fetchInformationUsingDOI = fetchInformationUsingDOI;
        window.renameOldKeys = renameOldKeys;
    </script>

    </script>

    <!-- jsConfetti init -->
    <script>
        const jsConfetti = new JSConfetti();
    </script>

    <script>
        const preprocessCondition = condition => {
            let processedCondition = condition
                .replaceAll(/([\$\w]+)\s*=\|=\s*\[(.*?)\]/g, (match, variable, list) => {
                    return "(" + list.split(",")
                        .map(value => `${variable} === ${value.trim()}`)
                        .join(" || ") + ")";
                })
                .replaceAll(/([\$\w]+)\s*=&=\s*\[(.*?)\]/g, (match, variable, list) => {
                    return "(" + list.split(",")
                        .map(value => `${variable} === ${value.trim()}`)
                        .join(" && ") + ")";
                })

            return processedCondition;
        }

        const insertValuesIntoCondition = condition => {
            return condition
                .replaceAll(/meta\$([a-zA-Z0-9_]+)/g, `Alpine.store('data').input[0]['$1']`)
                .replaceAll(/config\$([a-zA-Z0-9_.]+)/g, (match, keySequence) => {
                    const keys = keySequence.split('.');
                    return `Alpine.store('config').config['${keys.join("']['")}']`;
                })
                .replaceAll(/\$(\w*)/g, `context['$1']`);
        }

        const evaluateCondition = condition => condition ? evaluateConditionInContext(condition, Alpine.store('data').currentInput) : true;

        const evaluateConditionInContext = (condition, context) => {
            if (!condition) {
                return true;
            }

            const exists = id => !!id && id !== "";

            const c = insertValuesIntoCondition(preprocessCondition(condition))

            return eval(c);
        }

        const partialHighlight = (indicatorId, text) => {
            return text.replaceAll(/\{(.*?)\|(.*?)\}/g, (match, foundCondition, text) => {
                let condition = foundCondition.trim();

                if (condition.startsWith(':')) {
                    console.error('Condition starts with \':\' but no indicator ID is provided. The condition was: ', condition);
                    condition = `$${indicatorId} =|= [${condition.replace(':', '')}]`
                }

                return evaluateCondition(condition)
                    ? `<span class="highlight">${text.trim()}</span>`
                    : text
            });
        }

        const insertValuesIntoText = text => {
            const processType = {
                datetime: (value) => {
                    const millis = parseInt(value);
                    return millis ? new Date(millis).toLocaleString() : '...';
                },
                date: (value) => {
                    const millis = parseInt(value);
                    return millis ? new Date(millis).toLocaleDateString() : '...';
                },
                default: (value) => 'Unknown type'
            }

            const globals = {
                paper_count: (value) => Alpine.store('data').input.filter(r => r.type === 'pub' && r[value] === true).length,
            }

            return text
                .replaceAll(/meta\$([a-zA-Z0-9_]+)/g, (match, variable) => results[0][variable])
                .replaceAll(/global\$([a-zA-Z0-9_]+)@([a-zA-Z0-9_]+)/g, (match, variable, type) => {
                    return globals[type](variable);
                })
                .replaceAll(/config\$([a-zA-Z0-9_.]+)/g, (match, keySequence) => {
                    const keys = keySequence.split('.');
                    const value = eval(`Alpine.store('config').config['${keys.join("']['")}']`);
                    return value;
                })
                .replaceAll(/config\$([a-zA-Z0-9_]+)@([a-zA-Z0-9_]+)/g, (match, keySequence, type) => {
                    const keys = keySequence.split('.');
                    const value = eval(`Alpine.store('config').config['${keys.join("']['")}']`);
                    return processType[type](value);
                })
                .replaceAll(/\$([a-zA-Z0-9_]+?)@([a-zA-Z0-9_]+)/g, (match, variable, type) => {
                    return processType[type](Alpine.store('data').currentInput[variable]);
                })
                .replaceAll(/\$([a-zA-Z0-9_]+)/g, (match, variable) => {
                    return Alpine.store('data').currentInput[variable] ?? '...';
                });
        }

        const preprocessText = text => text ? insertValuesIntoText(partialHighlight(null, text)) : '';

        const preprocessTextWithIndicatorContext = (indicatorID, text) => text ? insertValuesIntoText(partialHighlight(indicatorID, text)) : '';

        const showSaving = () => {
            let saving = document.getElementById("saving");

            if (!saving) {
                return;
            }

            if (saving.style.display !== "none") {
                return;
            }

            saving.innerText = "Saving changes...";

            saving.style.display = "block";

            new Promise(r => setTimeout(r, 750))
                .then(() => {
                    saving.innerText = "Done ✅";
                });

            new Promise(r => setTimeout(r, 1500))
                .then(() => {
                    saving.style.display = "none";
                });
        }



        const checkCompletion = (result) => {
            const elements = Alpine.store('forms')[result.type].elements;

            if (!elements) {
                return {
                    progress: {
                        current: 0,
                        total: 0,
                        ratio: 0,
                        percent: ""
                    },
                    warnings: {}
                }
            }

            // We can't check progress of checkboxes
            const fillableElements = elements.filter(e => e.type !== 'checkbox' && e.type !== 'separator' && e.type !== 'info');

            // Get visible elements (required)
            const filteredElements = fillableElements
                .filter(e => evaluateConditionInContext(e.condition, result))
                // Filter out elements that are optional
                .filter(e => !e.optional);

            // Get visible elements that are filled out
            const filledOutElements = filteredElements.filter(e => result[e.id] !== '');

            const progress = filledOutElements.length / filteredElements.length;
            const progressPercent = Math.round(progress * 100).toFixed(0);

            let warnings = {};

            const emptyRequiredElements = filteredElements.filter(e => !filledOutElements.includes(e));

            emptyRequiredElements.forEach(e => {
                warnings[e.id] = {
                    importance: 'warning',
                    reason: 'empty',
                    text: 'This field is required.'
                };
            });

            return {
                progress: {
                    current: filledOutElements.length,
                    total: filteredElements.length,
                    ratio: progress,
                    percent: progressPercent
                },
                warnings: warnings
            }
        }

        const getProgressColor = value => {
            //value from 0 to 1
            let hue = (value * 120).toString(10);

            return `hsl(${hue}, 100%, 38%)`;
        }

        const celebrateCompletion = () => {
            jsConfetti.addConfetti({
                emojis: ['✅']
            });
        }

        let prefixes = {
            meta: "M",
            pub: "P",
            software: "S",
            data: "D"
        }
    </script>

    <script>
        Alpine.store('loaded', false);

        Alpine.store('forms', {
            meta: {},
            pub: {},
            software: {},
            data: {},
            config: {
                instructions: {
                    md: '',
                    html: ''
                }
            }
        });

        Alpine.store('indentations', {
            current: {},
            meta: {},
            pub: {},
            software: {},
            data: {}
        });

        Alpine.store('config', {
            config: {},
            queryConfig: {}
        });

        const getConfig = (type) => ({
            ...Alpine.store('forms')[type].config, // type specific config
            ...Alpine.store('forms').config, // global config
            ...Alpine.store('config').queryConfig.global, // global query config
            ...Alpine.store('config').queryConfig[type] // type specific query config
        })

        Alpine.store('selectedIndicator', {});

        Alpine.store('data', {
            input: {},
            topPapers: [],
            currentTab: parseInt(sessionStorage.getItem('currentTab') ?? '0'),
            currentInput: {},
            score: {},
            completion: {},

            manualInit() {
                this.input = JSON.parse(localStorage.getItem('data ' + Alpine.store('forms').config.main_title) ?? '[]');

                if (typeof this.input === "object" && this.input.length === 0) {
                    this.newResearchOutput('meta');
                }

                this.currentInput = this.input[this.currentTab];
                this.score = window.scoreAll(this.input, Alpine.store('config').config.score_categories || []);
                this.completion = this.input.map(checkCompletion);
                this.topPapers = this.input.filter(r => r.type === 'pub' && r.P_TopPaper_Select === true);
            },

            createResearchOutput(type) {
                return {
                    type,
                    version: Alpine.store('forms')[type].versions[prefixes[type]],
                    date_added: Date.now(),
                    ...window.getDefaultValues(Alpine.store('forms')[type].elements)
                }
            },

            newResearchOutput(type) {
                this.input.push(this.createResearchOutput(type));

                this.currentTab = this.input.length - 1;

                if (type === 'pub' && this.input.length === 2) {
                    driver(tourForm).drive();
                }
            },

            removeResearchOutput(index) {
                this.input.splice(index, 1);
                this.currentTab = 0;
            },

            reorderResearchOutputs(from, to) {
                const [removed] = this.input.splice(from, 1);
                this.input.splice(to, 0, removed);
            },

            addPublicationWithDetails(details) {
                this.input.push({
                    type: 'pub',
                    version: Alpine.store('forms')['pub'].versions[prefixes['pub']],
                    date_added: Date.now(),
                    ...window.getDefaultValues(Alpine.store('forms').pub.elements),
                    ...details
                });
            },

            clear() {
                localStorage.removeItem('data ' + Alpine.store('forms').config.main_title);
                sessionStorage.clear();
                this.input = [this.createResearchOutput('meta')];
                this.currentTab = 0;
                switchToTab(0);
            }
        });

        Alpine.store('warnings', {
            minROWarning: false,
            minScoreWarning: false,

            reevaluate() {
                this.minIndicatorsWarning = Alpine.store('data').score.scores[Alpine.store('data').currentTab].max > 0 && Alpine.store('data').score.scores[Alpine.store('data').currentTab].max < Alpine.store('config').config.min_indicators_warning_threshold;
                this.minROWarning = (Alpine.store('data').input.length - 1) < Alpine.store('config').config.min_ro_warning_threshold;
            },

            manualInit() {
                this.reevaluate();
            },

            any() {
                return this.minIndicatorsWarning || this.minROWarning;
            }
        });

        Alpine.effect(() => {
            if (!Alpine.store('loaded')) {
                return;
            }

            const data = Alpine.store('data').input;

            const currentTab = Alpine.store('data').currentTab;

            const newTopPapers = data.filter(r => r.type === 'pub' && r.P_TopPaper_Select === true);

            if (newTopPapers.length > Alpine.store('config').config.max_top_papers) {
                // set difference
                const diff = newTopPapers.filter(paper => !Alpine.store('data').topPapers.includes(paper));

                // undo change
                setTimeout(() => {
                    diff.forEach(paper => paper.P_TopPaper_Select = false);
                }, 0);

                // show warning
                alert(`You can only select ${Alpine.store('config').config.max_top_papers} top papers.`);

                return;
            }

            Alpine.store('data').topPapers = newTopPapers;

            const scores = window.scoreAll(data, Alpine.store('config').config.score_categories || []);

            Alpine.store('data').score = scores;

            const previousCompletions = Alpine.store('data').completion;
            const completions = data.map(checkCompletion);
            Alpine.store('data').completion = completions;

            if (completions[currentTab].progress.ratio === 1 && previousCompletions[currentTab].progress.ratio < 1) {
                celebrateCompletion();
            }



            Alpine.store('warnings').reevaluate();

            if (!data[0].date_created) {
                data[0].date_created = Date.now();
            }

            Alpine.store('data').input[0].date_modified = Date.now();

            showSaving();

            localStorage.setItem('data ' + Alpine.store('forms').config.main_title, JSON.stringify(data));

            window.renderScoreChart('overallScoreChart', scores.overall.categories, Alpine.store('config').config?.score_categories?.map(c => c.color) ?? [], animation = false);

            const currentScore = scores.scores[Alpine.store('data').currentTab];

            if (currentScore && currentScore.categories) {
                window.renderScoreChart('currentScoreChart', currentScore.categories, Alpine.store('config').config?.score_categories?.map(c => c.color) ?? [], animation = false);
            }
        });

        Alpine.effect(() => {
            if (!Alpine.store('loaded')) {
                return;
            }

            const currentTab = Alpine.store('data').currentTab;
            Alpine.store('data').date_modified = Date.now();
            sessionStorage.setItem('currentTab', currentTab);

            Alpine.store('data').currentInput = Alpine.store('data').input[currentTab];

            Alpine.store('config').config = getConfig(Alpine.store('data').currentInput.type);
        });

        Alpine.effect(async () => {
            if (!Alpine.store('loaded')) {
                return;
            }

            const doiTab = Alpine.store('data').currentTab;
            const doi = Alpine.store('data').input[doiTab].DOI;

            if (!doi) {
                return;
            }

            const publicationInformation = await window.fetchInformationUsingDOI(doi);

            Alpine.store('data').input[doiTab].Title = publicationInformation.title;
            Alpine.store('data').input[doiTab].Year = publicationInformation.year;
            Alpine.store('data').input[doiTab].Abstract = publicationInformation.abstract;

            if (!publicationInformation.error) {
                Alpine.store('data').input[doiTab].DOI = "https://doi.org/" + publicationInformation.DOI;
            }
        });

        Alpine.store('tabsSidebarScrollTop', 0);

        Alpine.store('showIndicators', true);

        Alpine.data('tab', () => ({
            hovering: false,
            showRemove: false,

            hoverStart() {
                this.hovering = true;
            },

            hoverEnd() {
                this.hovering = false;
                this.showRemove = false;
            },

            showRemoveButton() {
                this.showRemove = true;
            }
        }));

        const types = {
            'meta': 'Author / Metadata',
            'pub': 'Publication',
            'software': 'Software',
            'data': 'Data Set'
        };

        const switchToTab = (index) => {
            Alpine.store('showIndicators', false);
            Alpine.store('data').currentTab = index;
            setTimeout(() => Alpine.store('showIndicators', true), 0);
            document.querySelector('#formview').scrollTop = 0;
        }
    </script>

    <template x-if="$store.loaded">
        <div id="root">
            <div id="main">
                <div class="tabs-sidebar" id="tabs-sidebar" x-on:scroll="$store.tabsSidebarScrollTop = $el.scrollTop">
                    <div class="sidebar-top">                        
                        <div class="top">
                            <div style="display: flex; align-items: center;">
                                <h3><a href="https://www.resque.info" x-text="$store.config.config.main_title"></a></h3>
                                <template x-if="$store.config?.config?.image_url">
                                    <img :src="$store.config?.config?.image_url" 
                                        alt="University Logo" 
                                        style="height: 70px; max-width: 350px; object-fit: contain; margin: 10px; margin-left: 20px;"
                                    >
                                </template>
                            </div>
                            <div id="actions" style="margin-top: 10px; display: flex; flex-direction: row; gap: 10px;">
                                <button class="clear-button" @click="showModal('clear-modal')">Clear</button>
                                <button class="load-button" @click="triggerLoad()">Import from file ...</button>
                                <button class="save-button" @click="showExportModal()">Save to file ...</button>
                            </div>
                        </div>

                        <p><span
                                x-text="`${$store.data.input.length - 1} of ${Alpine.store('config').config.max} slots used`"></span><!--| <span class="fakelink"
                            @click="window.open(`https://shiny.psy.lmu.de/felix/RESQUE_profile?data=${LZString.compress(JSON.stringify($store.data.input))}`, '_blank')"
                        >View Profile ↗</span> --></p>
                    </div>
                    <div x-data="{ show: true }"
                        x-effect="if (show) document.querySelector('#tabs-sidebar').scrollTop = $store.tabsSidebarScrollTop;"
                        class="tabs-container">
                        <template x-if="show">
                            <div x-data="{ scrollY: 0 }">
                                <div class="tab metadata" @click="switchToTab(0)"
                                    :class="{ active: $store.data.currentTab === 0 }" style="position: relative;">
                                    <b>Author / Metadata</b>
                                    <div class="tab-progress-indicator"
                                        :style="`background-color: ${getProgressColor($store.data.completion[0].progress.ratio)};`"
                                        :title="`Progress: ${$store.data.completion[0].progress.percent}%`">
                                    </div>
                                </div>
                                <div
                                    x-sort="$store.data.reorderResearchOutputs($item, $position + 1); show = false; setTimeout(() => show = true, 0);">
                                    <template x-for="tab, index in $store.data.input.slice(1)" :key="index">
                                        <div x-sort:item="index + 1" style="position: relative;" x-data="tab">
                                            <template x-if="$store.data.input[index + 1]">
                                                <div>
                                                    <div @mouseover="hoverStart" @mouseout="hoverEnd"
                                                        @click="switchToTab(index + 1)"
                                                        x-html="`${$store.data.input[index + 1].P_TopPaper_Select ? '⭐️ ' : ''}<b>${types[tab.type]}</b><br>${$store.data.input[index + 1].Title ?? ''}`"
                                                        :class="{tab: true, active: $store.data.currentTab === index + 1}">
                                                    </div>
                                                    <span @mouseover="hoverStart" class="tab-delete-button tab-delete-menu"
                                                        @click="showRemoveButton" x-show="hovering && !showRemove">
                                                        X
                                                    </span>
                                                    <button class="critical tab-delete-menu" x-show="showRemove"
                                                        @click="$store.data.removeResearchOutput(index + 1)">
                                                        Remove
                                                    </button>
                                                </div>
                                            </template>
                                            <template x-if="$store.data.completion[index + 1]">
                                                <div class="tab-progress-indicator"
                                                    :style="`background-color: ${getProgressColor($store.data.completion[index + 1].progress.ratio)};`"
                                                    :title="`Progress: ${$store.data.completion[index + 1].progress.percent}%`">
                                                </div>
                                            </template>

                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div id="add-container">
                        <div class="doi-input" style="display:none">
                            <button class="pdf-button" onclick="document.getElementById('add-pdf').click()">Extract DOI
                                from
                                PDF</button>
                            <input id="add-doi" type="text" placeholder="DOI (optional)" />
                        </div>

                        <div class="add-buttons" x-show="($store.data.input.length - 1) < $store.config.config.max">
                            <button class="add-pub" @click="$store.data.newResearchOutput('pub')">Add
                                Publication</button>
                            <br />
                            <!-- REMOVED TEMPORARILY
                            <button class="add-software" @click="$store.data.newResearchOutput('software')">Add
                                Software</button>
                            <br />
                            <button class="add-data" @click="$store.data.newResearchOutput('data')">Add Data Set</button>
                            <hr />
                            -->
                            <button class="add-orcid" @click="showORCIDModal()">Import using ORCID</button>
                        </div>
                    </div>
                </div>
                <div id="formview-container">
                    <div id="saving" class="animate pop" style="display: none;"></div>
                    <div class="progressbar-frame">
                        <div class="progressbar-content"
                            :style="`width: ${$store.data.completion[$store.data.currentTab].progress.percent}%;`">
                        </div>
                    </div>
                    <div id="formview">
                        <h3 x-html="$store.forms[$store.data.currentInput.type].title"></h3>

                        <template x-if="$store.data.currentTab >= 0">
                            <template x-for="(elem, index) in $store.forms[$store.data.currentInput.type].elements"
                                :key="$store.data.currentInput.position + '_' + elem.id">
                                <template x-if="$store.showIndicators">
                                    <div @click="$store.selectedIndicator = elem"
                                        x-show="evaluateCondition(elem.condition)" onblur="actions[elem.onchange]()"
                                        class="indicator-container" :class="{ selected: $store.selectedIndicator.id === elem.id }" :class="elem.style_classes" :id="elem.id">
                 
                                        <template x-for="_ in [...Array($store.indentations[$store.data.currentInput.type][elem.id])]">
                                            <div class="indent"></div>
                                        </template>

                                        <div class="indicator-subcontainer" x-data="{ comment: false, hovering: false }" @mouseover="hovering = true" @mouseout="hovering = false">
                                            <div x-data="{ showWarningText: false }">
                                                <p>
                                                <div x-show="elem.id in $store.data.completion[$store.data.currentTab].warnings"
                                                    class="warning-indicator"
                                                    @click="showWarningText = !showWarningText">
                                                </div>
                                                <span class="title" x-html="preprocessText(elem.title)"></span> <span x-show="(hovering || comment) && !['separator', 'info'].includes(elem.type)" class="fakelink" @click="comment = !comment;" style="display: inline-block; white-space: nowrap;"><span x-show="!comment && !$store.data.currentInput[elem.id + '_Comment']">Add</span><span x-show="!comment && $store.data.currentInput[elem.id + '_Comment']">Edit</span><span x-show="comment">Save</span> comment</span>
                                                </p>
                                                <p x-text="$store.data.completion[$store.data.currentTab].warnings[elem.id]?.text"
                                                    x-show="showWarningText && elem.id in $store.data.completion[$store.data.currentTab].warnings"
                                                    class="warning-text">
                                                </p>
                                            </div>

                                            <div :id="`comment_${elem.id}`" tabindex="0" @blur="comment = false" @focus="comment = true" x-show="comment && !elem.no_comment" class="card comment-box" style="position: absolute; z-index: 2;">
                                                <p><b>Add a comment for '<span x-text="elem.id"></span>'</b></p>
                                                <form @submit.prevent="comment = false;" style="margin-bottom: 0;">
                                                    <input @focus="comment = true" @blur="comment = false" x-model="$store.data.currentInput[elem.id + '_Comment']"
                                                        type="text" :placeholder="`Comment on '${elem.id}'`" />
                                                </form>
                                            </div>

                                            <div class="content">
                                                <template x-if="elem.type === 'separator'">
                                                    <hr
                                                        style="height: 3px; border:none; color: #333; background-color: #333;" />
                                                </template>

                                                <template x-if="elem.type === 'info'">
                                                    <p x-html="preprocessText(elem.text)"></p>
                                                </template>

                                                <template x-if="elem.type === 'text'">
                                                    <input x-model="$store.data.currentInput[elem.id]" type="text"
                                                        :placeholder="elem.title || ''" />
                                                </template>

                                                <template x-if="elem.type === 'textbox'">
                                                    <div>
                                                        <div class="textbox" contenteditable
                                                            x-init="$el.innerText = $store.data.currentInput[elem.id] ?? ''"
                                                            @input="$store.data.currentInput[elem.id] = $event.target.innerText.trim()"
                                                            :placeholder="elem.title || ''"></div>

                                                        <template x-if="!!elem.maxwords">
                                                            <p class="wordcount"
                                                                :class="(($store.data.currentInput[elem.id] ?? '').match(/\S+/g) ?? []).length > elem.maxwords ? 'wordcount-warning' : ''"
                                                                x-text="`${(($store.data.currentInput[elem.id] ?? '').match(/\S+/g) ?? []).length} / ${elem.maxwords} words`">
                                                            </p>
                                                        </template>
                                                    </div>
                                                </template>

                                                <template x-if="elem.type === 'number'">
                                                    <input x-model="$store.data.currentInput[elem.id]" type="text"
                                                        :placeholder="elem.title || ''" />
                                                </template>

                                                <template x-if="elem.type === 'date'">
                                                    <input x-model="$store.data.currentInput[elem.id]" type="date"
                                                        :placeholder="elem.title || ''" />
                                                </template>

                                                <template x-if="elem.type === 'dropdown'">
                                                    <select x-model="$store.data.currentInput[elem.id]">
                                                        <template x-for="option in elem.options" :key="option.id">
                                                            <p x-text="option.text"></p>
                                                            <option x-html="option.text" :value="option.id"></option>
                                                        </template>
                                                    </select>
                                                </template>

                                                <template x-if="elem.type === 'radio'">
                                                    <div
                                                        :class="elem.alignment ? 'alignment-' + elem.alignment : 'alignment-vertical'">
                                                        <template x-for="option in elem.options" :key="option.id">
                                                            <label :for="elem.id + '_' + option.id">
                                                                <input x-model="$store.data.currentInput[elem.id]"
                                                                    type="radio" :name="elem.id"
                                                                    :id="elem.id + '_' + option.id"
                                                                    :value="option.id" />
                                                                <span x-html="option.text"></span>
                                                            </label>
                                                        </template>
                                                    </div>
                                                </template>

                                                <template x-if="elem.type === 'checkbox'">
                                                    <template x-for="option in elem.options" :key="option.id">
                                                        <label :for="elem.id + '_' + option.id">
                                                            <input
                                                                x-model="$store.data.currentInput[elem.id + '_' + option.id]"
                                                                type="checkbox" :id="elem.id + '_' + option.id" />
                                                            <span x-html="option.text"></span>
                                                        </label>
                                                    </template>
                                                </template>

                                                <template x-if="elem.type === 'tabular_radio'">
                                                    <div>
                                                        <table>
                                                            <thead style="background-color: var(--bg-color); position: sticky; top: 0; z-index: 1;">
                                                                <tr>
                                                                    <th></th>
                                                                    <template x-for="option in elem.options"
                                                                        :key="option.id">
                                                                        <th x-html="option.text"></th>
                                                                    </template>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <template x-for="row in elem.rows" :key="row.id">
                                                                    <!-- Stop event propagation to separate child and parent pointer events -->
                                                                    <tr @click="e => { 
                                                                        e.stopPropagation();
                                                                        $store.selectedIndicator = {
                                                                            id: elem.id + '_' + row.id,
                                                                            info: row.info,
                                                                            background: row.background,
                                                                            tip_external: row.tip_external 
                                                                        };}">
                                                                        <td x-html="row.title"></td>
                                                                        <template x-for="option in elem.options"
                                                                            :key="option.id">
                                                                            <td>
                                                                                <input
                                                                                    x-model="$store.data.currentInput[elem.id + '_' + row.id]"
                                                                                    type="radio"
                                                                                    :name="elem.id + '_' + row.id"
                                                                                    :id="elem.id + '_' + row.id + '_' + option.id"
                                                                                    :value="option.id" />
                                                                                <div class="tabular-option-info"
                                                                                    x-text="`${option.text}`"></div>
                                                                            </td>
                                                                        </template>
                                                                    </tr>
                                                                </template>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </template>
                                            </div>

                                            <div class="warning-text" x-show="elem.validation && (!RegExp(elem.validation.pattern).test($store.data.currentInput[elem.id]) || !evaluateCondition(elem.validation.condition))">
                                                <span x-text="elem.validation?.message"></span>
                                            </div>

                                            <div x-show="$store.data.currentInput[elem.id + '_Comment'] && !elem.no_comment">
                                                <i style="color: gray;" ><span><b>Comment:</b> </span><span x-text="$store.data.currentInput[elem.id + '_Comment']"></span></i>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </template>
                        </template>
                    </div>
                </div>
                <div id="menu" x-data="{ tab: 'main' }">
                    <div id="menu-tabs">
                        <span @click="tab = 'main'" :class="{ selected: tab === 'main' }">Score/Info</span> • <span
                            @click="tab = 'problems'" :class="{ selected: tab === 'problems' }">Problems (<span
                                x-text="Object.keys($store.data.completion[$store.data.currentTab].warnings).length"></span>)</span>
                    </div>
                    <div x-show="tab === 'problems'" class="warning-box card animate pop">
                        <template
                            x-if="Object.keys($store.data.completion[$store.data.currentTab].warnings).length > 0">
                            <div>
                                <template
                                    x-for="[id, warning] in Object.entries($store.data.completion[$store.data.currentTab].warnings)">
                                    <div @click="document.getElementById(id).scrollIntoView({behavior: 'smooth', block: 'center'}); document.querySelector('html').scrollTop = 0;"
                                        class="warning-text list-item">
                                        <b><span x-text="id"></span></b>
                                        <br>
                                        <span x-text="warning.text"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template
                            x-if="Object.keys($store.data.completion[$store.data.currentTab].warnings).length === 0">
                            <p style="margin: 0; color: gray;">No problems found.</p>
                        </template>
                    </div>
                    <div class="card animate pop" :class="{ warning: $store.warnings.any() }" id="score-box"
                        x-show="!$store.config.config.hide_score && tab === 'main' && $store.data.currentInput.type !== 'meta'">
                        <div id="score-container">
                            <div id="current-score">
                                <span class="sub">Selected research output</span>
                                <div x-show="$store.data.score.scores[$store.data.currentTab].max <= 0">
                                    <span id="no-score">Applicant requests<br>manual processing</span>
                                </div>

                                <div style="width: 150px; height: 150px;"
                                    x-show="$store.data.score.scores[$store.data.currentTab].max > 0">
                                    <canvas id="currentScoreChart" width="150" height="150"
                                        style="margin-top: 10px;"></canvas>
                                </div>
                            </div>
                            <div id="overall-score">
                                <span class="sub">Overall Profile (mean)</span>

                                <div style="width: 150px; height: 150px;">
                                    <canvas id="overallScoreChart" width="150" height="150"
                                        style="margin-top: 10px;"></canvas>
                                </div>
                            </div>
                        </div>

                        <div id="legend-container"></div>

                        <p id="ro-count-container"><span class="tag"><span
                                    x-text="$store.data.score.scores.filter(s => s.max && s.max > 0).length"></span>
                                scored
                                research output(s)</span>
                        </p>

                        <details class="scoring-details">
                            <summary>Details</summary>
                            <div id="score-details">
                                <h3>Selected research output</h3>
                                <hr>
                                <div x-show="$store.data.score.scores[$store.data.currentTab].max > 0"
                                    id="current-score-container">
                                    <p id="score-percentage"><span
                                            x-text="$store.data.score.scores[$store.data.currentTab].percentage"></span>%
                                    </p>
                                    <p id="score-dot">•</p>
                                    <p id="score-minmax"><span
                                            x-text="$store.data.score.scores[$store.data.currentTab].score?.toFixed(2)"></span>/<span
                                            x-text="$store.data.score.scores[$store.data.currentTab].max?.toFixed(2)"></span>
                                    </p>
                                </div>
                                <hr>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Score</th>
                                            <th>Max</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template
                                            x-for="category in $store.data.score.scores[$store.data.currentTab].categories"
                                            :key="category.title">
                                            <tr>
                                                <td x-text="category.title"></td>
                                                <td x-text="category.score.toFixed(2)"></td>
                                                <td x-text="category.max.toFixed(2)"></td>
                                        </template>
                                    </tbody>
                                </table>
                                <h3>Overall</h3>
                                <hr>
                                <div id="overall-score-container">
                                    <p id="overall-score-percentage"><span
                                            x-text="$store.data.score.overall.percentage"></span>%</p>
                                </div>
                                <hr>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Score</th>
                                            <th>Max</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="category in $store.data.score.overall.categories"
                                            :key="category.title">
                                            <tr>
                                                <td x-text="category.title"></td>
                                                <td x-text="category.score.toFixed(2)"></td>
                                                <td x-text="category.max.toFixed(2)"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </details>
                        <p id="warning-score-too-low" x-show="$store.warnings.minIndicatorsWarning">⚠️ Many indicators
                            are not
                            applicable. Manual processing of this
                            publication is recommended.
                        </p>
                        <p id="warning-min-ro-threshold" x-show="$store.warnings.minROWarning">⚠️ Please provide at
                            least <span id="minROWarningThreshold"
                                x-text="$store.config.config.minROWarningThreshold"></span>
                            research contributions that can be scored</p>
                    </div>
                    <div x-show="tab === 'main'" id="info-box" class="card">
                        <template x-if="!$store.selectedIndicator.id">
                            <p id="item-info">Click on an indicator to see detailed information</p>
                        </template>

                        <template x-if="$store.selectedIndicator.id">
                            <div>
                                <p style="margin: 0;">
                                    <b><span x-text="$store.selectedIndicator.id"></span></b>
                                    <template x-if="$store.selectedIndicator.info">
                                        <div>
                                            <br>
                                            <span
                                                x-html="preprocessTextWithIndicatorContext($store.selectedIndicator.id, $store.selectedIndicator.info)"></span>
                                        </div>
                                    </template>
                                    <template x-if="!$store.selectedIndicator.info">
                                        <p style="color: gray; margin: 0;"><br><i>No information.</i></p>
                                    </template>
                                </p>
                                <template x-if="$store.selectedIndicator.background">
                                    <details id="item-background-details">
                                        <summary>Background information</summary>
                                        <span id="item-background"
                                            x-html="preprocessTextWithIndicatorContext($store.selectedIndicator.id, $store.selectedIndicator.background)"></span>
                                    </details>
                                </template>
                                <template x-if="$store.selectedIndicator.tip_external">
                                    <details id="tip-external-details"
                                        :open="$store.data.input[0].RaterType === 'External'">
                                        <summary>Tips for external raters</summary>
                                        <span id="tip-external"
                                            x-html="preprocessTextWithIndicatorContext($store.selectedIndicator.id, $store.selectedIndicator.tip_external)"></span>
                                    </details>
                                </template>
                            </div>
                        </template>
                    </div>
                    <div class="menu-bottom">
                        <a class="fakelink" href="https://www.resque.info">RESQUE Website</a> • <span
                            onclick="showInfoModal()" class="fakelink">FAQ</span> • <a class="github-link"
                            href="https://github.com/RESQUE-Framework/collector-app">GitHub</a> • <span
                            onclick="driver(tourAnytime()).drive()" class="fakelink">Tour</span> • <span
                            onclick="showInstructionsModal()" class="fakelink">Instructions</span>
                    </div>
                    <div x-show="$store.config.config.show_beta_warning" style="margin-top: 20px;" x-cloak>
                            <span style='background-color: lightyellow; font-size:80%;'>[Note: The RESQUE collector app is in beta stage and might change in the near future. If you want to use it in practice, please <a href="https://www.resque.info/team.html">contact</a> us.]</span>
                    </div>
                </div>
            </div>
            <div id="info-modal" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <button onclick="closeInfoModal()" id="add-modal-continue">Continue</button>

                    <h2>👋🏻 Welcome to the RESQUE tool!</h2>
                    <p>We need to change the way we assess research - with a focus on quality (over quantity). The <a
                            href="https://github.com/RESQUE-Framework/collector-app">RESearch QUality Evaluation
                            (RESQUE)</a>
                        framework
                        provides an evaluation scheme for publications, data sets, and research software. With this
                        tool, you
                        can enter the necessary information for your best research outputs, export a profile that shows
                        your
                        research style (<i>not implemented yet</i>), and use it for your CV or in hiring and tenure
                        committees.
                    </p>
                    <hr>
                    <h3>👀 How to use the RESQUE tool?</h3>
                    <details>
                        <summary>How do I add a new publication / software project / data set?</summary>
                        Normally, you would use the buttons in the sidebar on the left.
                        <br>
                        For this time, you can do it here:
                        <br><br>
                        <button onclick="newTab('pub')">New Publication</button>
                        <button onclick="newTab('software')">New Software Project</button>
                        <button onclick="newTab('data')">New Data Set</button>
                    </details>
                    <details>
                        <summary>How do I save my data?</summary>
                        Clicking on the <button onclick="exp()">Save as file ...</button> button here or in the top left
                        corner
                        of this website exports a <code>.json</code> file. You can save this on your computer and share
                        it with
                        others.
                    </details>
                    <details>
                        <summary>How do I load data I previously saved?</summary>
                        You can use the <button onclick="triggerLoad()">Load</button> button here or in the top left
                        corner of
                        this website.
                    </details>
                    <details>
                        <summary>How can I clear all information I entered?</summary>
                        You can delete all data stored in the browser by clicking on the <button
                            onclick="showModal('clear-modal')">Clear</button> button here or in the top left corner of
                        this
                        website.
                    </details>
                    <details>
                        <summary>What should I do if I want to use RESQUE on a shared/public computer?</summary>
                        Whenever you open this website, it loads the locally stored data. On public computers, make sure
                        that
                        you clear your data after you saved them as a file.
                    </details>
                    <hr>
                    <h3>🔒 Privacy • <span class="sub">Is my data stored privately in a safe location?</span></h3>
                    <p>
                        <b>No data leaves your device.</b>
                        <br>
                        We use the <a href="https://www.wikiwand.com/en/Web_storage">Web Storage API</a> supported by
                        all major
                        browsers. Although the website itself is hosted on a server, your data is <i>only</i> stored and
                        processed in the local browser:
                        <br><br>
                        The data is processed only locally. Your score is calculated in the browser. The local PDF files
                        you
                        open on this website are <i>not</i> uploaded to a server.
                        <br><br>
                        To get a sense of how many users we have, we do a very basic access logging with Matomo. You are
                        not
                        identifiable by the logged information; none of your entered data is tracked; no cookies or
                        third party
                        trackers are used.
                    </p>
                </div>
            </div>
            <dialog id="clear-modal">
                <h3>⚠️ Warning!</h3>
                <p><b>This will delete all of your local data.</b><br><br>Do you want to save the data to a file first?
                </p>
                <br>
                <button onclick="closeModal('clear-modal')">Cancel</button> <button onclick="exp()">Save data to local
                    file</button>
                <button @click="$store.data.clear(); closeModal('clear-modal')" class="critical">Clear all data</button>
            </dialog>

            <dialog id="config-incompatible-modal">
                <h3>Incompatible configuration</h3>
                <p>You have old data present, which was created using a different configuration. Do you want to load it,
                    or
                    start with a fresh form?</p>
                <p>Your data might be incompatible with the current configuration and lead to unexpected behavior.
                </p>
                <br>
                <div class="buttons">
                    <button onclick="saveCurrentQueryConfig(); closeModal('config-incompatible-modal')">Use old
                        data</button>
                    <button onclick="showModal('clear-modal')" class="critical">Clear everything and start
                        fresh</button>
                </div>
            </dialog>

            <div id="instructions-modal" class="modal">
                <div class="modal-content">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 x-text="$store.config?.config?.main_title"></h2>
                        <template x-if="$store.config?.config?.image_url">
                            <img :src="$store.config?.config?.image_url" alt="University Logo" style="height: 80px;">
                        </template>
                    </div>
                    <template x-if="$store.config.config?.instructions?.html">
                        <div x-html="$store.config.config?.instructions?.html || ''"></div>
                    </template>
                    <div 
                        x-show="$store.data.input.length <= 1"
                        style="text-align: right; position: sticky; bottom: 0;">
                        <button style="background-color: #333; color: #efefef; border-radius: 99px; border: 4px solid #00000055; background-clip: padding-box;"
                            @click="closeInstructionsModal(); driver(tourMain).drive()">Start tour →</button>
                    </div>
                </div>
            </div>

            <div id="orcid-modal" class="modal">
                <div x-data="{ orcid: '', authorName: '', publications: [] }" class="modal-content">
                    <h3>Import publications using ORCID</h3>
                    <input id="orcid-modal-input" x-model="orcid" type="text" placeholder="ORCID" />
                    <button id="orcid-modal-button"
                        @click="window.fetchAuthorByORCID(orcid).then(name => authorName = name); window.fetchPapersByORCID(orcid).then(ps => publications = ps)">Fetch
                        Publications</button>

                    <template x-if="publications.length">
                        <div>
                            <hr>
                            <div style="position: sticky; top: 0; background-color: white; padding: 2px 0;">
                                <div
                                    style="display: flex; flex-direction: row; justify-content: space-between; align-items: center;">
                                    <h3 x-text="`${authorName} (${publications.length} publications)`"></h3>
                                    <button
                                        @click="publications.filter(p => p.selected).forEach(p => $store.data.addPublicationWithDetails({DOI: 'https://doi.org/' + p.doi, Title: p.title, Year: p.year})); closeORCIDModal(); orcid = '', authorName ='', publications = []"><span
                                            x-text="`Add ${publications.filter(p => p.selected).length} Publications`"></span></button>
                                </div>
                            </div>
                            <template x-for="pub in publications">
                                <div @click="pub.selected = !pub.selected" class="tab"
                                    :class="{ active: pub.selected }">
                                    <p style="margin-top: 0;"><b x-text="pub.title"></b></p>
                                    <p style="margin-bottom: 0;"><span x-text="pub.year"></span> | <a
                                            style="color: inherit;" :href="`https://doi.org/${pub.doi}`"
                                            target="_blank"><span x-text="pub.doi"></span></a></p>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <div id="export-modal" class="modal">
                <div x-data="{ excludedPublications: new Set() }" class="modal-content">

                    <div style="position: sticky; top: 0; background-color: white; padding: 2px 0;">
                        <div>
                            <h3>Save to file...<span style="font-size: 70%; font-weight: normal;">&nbsp;&nbsp;Click
                                    publications to (de)select</span></h3>
                            <div style="padding-bottom: 1rem;">                                
                                <button
                                    :disabled="excludedPublications.size >= $store.data.input.length - 1 || $store.data.input.length - 1 - excludedPublications.size > $store.config.config.max || $store.data.input.filter(ro => ro.P_TopPaper_Select).length < $store.config.config.max_top_papers"
                                    @click="exp(excludedPublications); excludedPublications = new Set(); closeExportModal();">Export
                                    <span x-text="$store.data.input.length - 1 - excludedPublications.size"></span> selected outputs for hiring committee</button>
                                    <button @click="exp(); closeExportModal();">Export all data (for personal archive)</button>
                            </div>
                        </div>

                        <div class="warning-text" x-show="$store.data.input.length - 1 - excludedPublications.size > $store.config.config.max">
                            <span>The committee requests a maximum of <span x-text="$store.config.config.max"></span> publications - please select only <span x-text="$store.config.config.max"></span> entries.</span>
                        </div>

                        <div class="warning-text" x-show="$store.data.input.filter(ro => ro.P_TopPaper_Select).length < $store.config.config.max_top_papers">
                            <span>The committee asks you to select <span x-text="$store.config.config.max_top_papers"></span> publications as your best publications - you only select <span x-text="$store.data.input.filter(ro => ro.P_TopPaper_Select).length"></span> entries. Please go back and select exactly <span x-text="$store.config.config.max_top_papers"></span>.</span>
                        </div>

                    </div>

                    <div>
                        <template x-for="pub, index in $store.data.input.slice(1)">
                            <div class="tab" :class="{ 'active': !excludedPublications.has(index + 1) }"
                                @click="if (excludedPublications.has(index + 1)) { excludedPublications.delete(index + 1); } else { excludedPublications.add(index + 1); }">
                                <p style="margin: 0;"><span x-show="pub.P_TopPaper_Select">⭐️ </span><span
                                        x-text="pub.Title"></span></p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <input id="fileInput" type="file" accept="application/json" style="visibility: hidden"
                @change="handleLoad($el.files)" />
            <a id="download" style="visibility: hidden"></a>
            <input id="add-pdf" type="file" accept="application/pdf" onchange="handleSelectPDF(this.files)"
                style="visibility: hidden;" />
        </div>
    </template>

    <div id="mobile">
        <div class="card">
            This window is too small for the <b>RESQUE</b> tool.
            <br><br> Please visit <a
                href="https://resque-framework.github.io/collector-app">resque-framework.github.io/collector-app</a> on
            a computer. If you are already on a computer, please make this window larger.
            <hr>
            <a class="github-link" href="https://github.com/RESQUE-Framework/collector-app">GitHub</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/object-hash@3.0.0/dist/object_hash.min.js"></script>
    <script>
        const driver = window.driver.js.driver;

        const tourMain = {
            showProgress: true,
            steps: [
                { popover: { title: '👋🏻 Welcome to the RESQUE tool!', description: 'We need to change the way we assess research - with a focus on quality (over quantity). The RESearch QUality Evaluation (RESQUE) framework provides an evaluation scheme for publications, data sets, and research software for psychological research. With this tool, you can enter the necessary information for your best research outputs, export a profile that shows your research style (not implemented yet), and use it for your CV or in hiring and tenure committees. <br><span style="background-color: lightyellow; font-size:80%;">[Note: The RESQUE is still a beta version and in active development.]</span><br><br><hr><br>If you use the app in <span style="background-color: lightyellow;">an application process</span> and have troubles or questions, you can (confidentially) contact Prof. Felix Schönbrodt (<a href="mailto:felix.schoenbrodt@psy.lmu.de">felix.schoenbrodt@psy.lmu.de</a>) or Prof. Anne Gärtner (<a href="mailto:anne.gaertner@fu-berlin.de">anne.gaertner@fu-berlin.de</a>) for consultation.' } },
                { popover: { title: '🔒 Privacy', description: 'The data you enter never leaves your device. Everything is processed locally. (except fetching the information about a publications using the DOI)' } },
                { element: '.save-button', popover: { title: 'Saving changes...', description: 'Your changes are saved automatically in your browser. You can reload the page or close this tab and come back another time, the data you entered will still be here. Nonetheless, you should regularly make backups from your data by saving the data in a local file.' } },
                // { element: '.pdf-button', popover: { description: 'You can open a PDF file and extract the DOI automatically. Note that this might fail in rare cases.' } },
                { element: '.metadata', popover: { title: 'The first step', description: 'As a first step, please fill in the information on the <b>Author/Metadata tab</b>.' } },
                { element: '.add-pub', popover: { title: 'Adding publications (1/2)', description: 'After that you can start to add a new publication. You can do this manually by clicking on the <b>Add Publication</b> button ...' } },
                { element: '.add-orcid', popover: { title: 'Adding publications (2/2)', description: '... or you can add multiple publications at once by selecting them from your ORCID profile.' } },
            ]
        };

        const tourForm = {
            showProgress: true,
            steps: [
                { popover: { title: '🎉 You added your first publication!', description: 'We will continue showing you around.' } },
                { element: '#DOI', popover: { description: 'You can enter the DOI here. We\'ll get the title and the year of publication from doi.org after you click away from the text field.' } },
                { element: '#score-box', popover: { title: 'Score box', description: 'You see the score for the current research output and the overall score for all research outputs here.' } },
                { element: '#info-box', popover: { title: 'Info box', description: 'You can click on an indicator in the form to see some help or detailed information here.' } },
                { element: '.clear-button', popover: { title: 'Starting fresh', description: 'You can use the \'Clear\' button to delete everything you entered and start with a fresh form.' } },
                { element: '.load-button', popover: { title: 'Loading previously exported data', description: 'The \'Load\' button opens a file picker, the local JSON file you select will be loaded into the tool.' } },
                { element: '.save-button', popover: { title: 'Saving to a local file', description: 'If you want to export your data and save it to a local file (for example if you want to send the data to another person), you can use this button. A JSON file will be saved to your computer.' } },

                { element: '.menu-bottom', popover: { description: 'You can click on FAQ to read more. You can also always take this tour by clicking on \'Tour\'' } },
            ]
        };

        const tourAnytime = () => {
            return {
                showProgress: true,
                steps: [
                    { popover: { title: '👋🏻 Welcome to the RESQUE tool!', description: 'We need to change the way we assess research - with a focus on quality (over quantity). The RESearch QUality Evaluation (RESQUE) framework provides an evaluation scheme for publications, data sets, and research software. With this tool, you can enter the necessary information for your best research outputs, export a profile that shows your research style (not implemented yet), and use it for your CV or in hiring and tenure committees.' } },
                    { popover: { title: '🔒 Privacy', description: 'The data you enter never leaves your device. Everything is processed locally. (except fetching the information about a publications using the DOI)' } },
                    { popover: { title: 'Saving changes...', description: 'Your changes are saved automatically in your browser. You can reload the page or close this tab and come back another time, the data you entered will still be here.' } },
                    // { element: '.pdf-button', popover: { description: 'You can open a PDF file and extract the DOI automatically. Note that this might fail in rare cases.' } },
                    { element: '.add-buttons', popover: { title: 'Add a new research output', description: 'You can use one of these two buttons to add new research outputs. RESQUE currently only considers publications as research outputs (software projects and data sets are in development). Use the ORCID button to bulk import multiple publications.' } },
                    { element: '.clear-button', popover: { title: 'Starting fresh', description: 'You can use the \'Clear\' button to delete everything you entered and start with a fresh form.' } },
                    { element: '.load-button', popover: { title: 'Loading previously exported data', description: 'The \'Load\' button opens a file picker, the local JSON file you select will be loaded into the tool.' } },
                    { element: '.save-button', popover: { title: 'Saving to a local file', description: 'If you want to export your data and save it to a local file (for example if you want to send the data to another person), you can use this button. A JSON file will be saved to your computer.' } },

                    Alpine.store('data').currentInput.type === 'pub' ? { popover: { description: "Let's continue with the form and the right menu." } } : { popover: { title: 'Please switch to a publication tab', description: 'In order to continue the tour, you have to be on a publication tab. Add a new publication or switch to an existing one and start the tour again.' } },
                    { element: '#DOI', popover: { description: 'You can enter the DOI here. We\'ll get the title and the year of publication from doi.org after you click away from the text field.' } },
                    { element: '#score-box', popover: { title: 'Score box', description: 'You see the score for the current research output and the overall score for all research outputs here.' } },
                    { element: '#info-box', popover: { title: 'Info box', description: 'You can click on an indicator in the form to see some help or detailed information here.' } },

                    { element: '.menu-bottom', popover: { description: 'You can click on FAQ to read more. You can also always take this tour by clicking on \'Tour\'' } },
                ]
            }
        }
    </script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

        function extractText(pdf) {
            var totalPageCount = pdf.numPages;
            var countPromises = [];
            for (
                var currentPage = 1;
                currentPage <= totalPageCount;
                currentPage++
            ) {
                var page = pdf.getPage(currentPage);
                countPromises.push(
                    page.then(function (page) {
                        var textContent = page.getTextContent();
                        return textContent.then(function (text) {
                            return text.items
                                .map(function (s) {
                                    return s.str;
                                })
                                .join(' ');
                        });
                    }),
                );
            }

            return Promise.all(countPromises).then(function (texts) {
                return texts.join(' ');
            })
        }

        function handleSelectPDF(files) {
            var file = files[0];

            //Step 2: Read the file using file reader
            var fileReader = new FileReader();

            fileReader.onload = function () {

                //Step 4:turn array buffer into typed array
                var typedarray = new Uint8Array(this.result);

                //Step 5:pdfjs should be able to read this
                const loadingTask = pdfjsLib.getDocument(typedarray);
                loadingTask.promise.then(pdf => {
                    extractText(pdf).then(text => {
                        let dois = extractDOIs(text);
                        document.getElementById('add-doi').value = dois[0];

                        if (mode === MODE_PREVIEW || mode === MODE_PRINT) {
                            console.log(text);
                            console.log(dois);
                        }
                    })
                });
            };
            //Step 3:Read the file as ArrayBuffer
            fileReader.readAsArrayBuffer(file);
        }

        function extractDOIs(text) {
            let pattern = /\b10\.\d{4,9}\/[-._;()/:a-zA-Z0-9]+\b/g;
            const dois = text.match(pattern);

            return [...new Set(dois)];
        }
    </script>

    <script>


        async function use(config, ...packs) {

            const pool = [];

            const ps = await Promise.all(packs.map(async pack => {
                const response = await fetch("./" + pack);
                return response.json();
            }));

            ps.forEach(p => pool.push(...p.elements));

            let versions = {};

            ps.forEach(pack => versions[pack.prefix] = pack.version);

            let date = {};

            ps.forEach(pack => date[pack.prefix] = pack.date);

            let scoringInfos = {}

            ps.forEach(pack => scoringInfos = { ...scoringInfos, ...pack.scoring })

            return {
                title: ps[0].title,
                versions,
                date,
                scoring: scoringInfos,
                pool,
                config
            };
        }

        function pick(combinedPack, ...ids) {
            return {
                title: combinedPack.title,
                versions: combinedPack.versions,
                date: combinedPack.date,
                scoring: combinedPack.scoring,
                config: combinedPack.config,
                elements: ids.length <= 0 ? combinedPack.pool : ids.map(id => combinedPack.pool.find(item => item.id === id))
            };
        }

        function pickByPrefix(combinedPack, prefix) {
            return {
                title: combinedPack.title,
                versions: combinedPack.versions,
                date: combinedPack.date,
                scoring: combinedPack.scoring,
                config: combinedPack.config,
                elements: combinedPack.pool.filter(item => item.id.startsWith(prefix))
            };
        }

        function pickByCondition(combinedPack, condition) {
            return {
                title: combinedPack.title,
                versions: combinedPack.versions,
                date: combinedPack.date,
                scoring: combinedPack.scoring,
                config: combinedPack.config,
                elements: combinedPack.pool.filter(item => condition(item))
            };
        }

        function pickExclude(combinedPack, ...ids) {
            return pickByCondition(combinedPack, item => !ids.includes(item.id));
        }
    </script>

    <script src="menu.js"></script>

    <script>
        const MODE_PREVIEW = "preview";
        const MODE_PRINT = "print";

        // Modal

        window.onclick = e => {
            if (event.target.classList.contains("modal")) {
                e.target.style.display = "none";
            }
        }

        const showModal = (id) => {
            document.getElementById(id).showModal();
        }

        const closeModal = (id) => {
            document.getElementById(id).close();
        }

        const showInfoModal = () => {
            document.getElementById("info-modal").style.display = "block";
        }

        const closeInfoModal = () => {
            document.getElementById("info-modal").style.display = "none";
        }

        const showInstructionsModal = () => {
            document.getElementById("instructions-modal").style.display = "block";
        }

        const closeInstructionsModal = () => {
            document.getElementById("instructions-modal").style.display = "none";
        }

        const showORCIDModal = () => {
            const orcidInput = document.querySelector("#orcid-modal-input");
            const orcidButton = document.querySelector("#orcid-modal-button");

            // Extract ORCID from the input
            let extractedORCID = (Alpine.store('data').input[0].ORCID ?? '').replace('https://orcid.org/', '');

            // See orcid-modal to understand why the following lines work

            // Set the input
            orcidInput.value = extractedORCID;
            orcidInput.dispatchEvent(new Event('input'));

            // Click the button to fetch works
            orcidButton.click();

            document.getElementById("orcid-modal").style.display = "block";
        }

        const closeORCIDModal = () => {
            document.getElementById("orcid-modal").style.display = "none";
        }

        const showExportModal = () => {
            document.getElementById("export-modal").style.display = "block";
        }

        const closeExportModal = () => {
            document.getElementById("export-modal").style.display = "none";
        }


        const reset = () => {
            results = {};
            localStorage.clear();
            sessionStorage.clear();
            location.reload();
        }

        const triggerLoad = () => {
            fileSelector = document.getElementById("fileInput");
            fileSelector.click();
        }

        const handleLoad = async files => {
            let loadedData = JSON.parse(await files[0].text());

            // Apply the aliases to all research outputs
            loadedData = loadedData.map(window.renameOldKeys);

            if (loadedData.every(r => Alpine.store('forms')[r.type].versions[prefixes[r.type]] === r.version)) {
                Alpine.store('data').input = loadedData;
                sessionStorage.clear();
            } else {
                alert("Warning: the data in the local file was created using an earlier version. Trying to load it anyway.");

                // Temporary: Load anyway!!
                Alpine.store('data').input = loadedData;
                sessionStorage.clear();
            }
        }

        const filterExport = (result) => {
            const elements = Alpine.store('forms')[result.type].elements;

            const allIds = elements.map(e => e.id);

            const filteredElements = elements
                .filter(e => evaluateConditionInContext(e.condition, result));

            const checkboxIds = filteredElements
                .filter(e => e.type === 'checkbox')
                .map(e => e.options.map(o => e.id + '_' + o.id))
                .flat();

            const tabularRadioIds = filteredElements
                .filter(e => e.type === 'tabular_radio')
                .map(e => e.rows.map(r => e.id + '_' + r.id))
                .flat();

            const filteredIds = [
                ...filteredElements.map(e => e.id),
                ...checkboxIds,
                ...tabularRadioIds,
                ...(filteredElements.map(e => e.id + '_Comment')),
                'Title', 'Year', 'Abstract',
                'date_added', 'position', 'type', 'version'
            ];

            const filteredData = Object.fromEntries(
                Object.entries(result).filter(([key, value]) => filteredIds.includes(key))
            );

            return filteredData;
        }

        // The export function "Save to file ..."
        const exp = (excluded) => {
            if (!excluded) {
                excluded = new Set();
            }

            let data = Alpine.store('data').input
                // only export the data that is currently visible
                .map(filterExport);

            let millis = Date.now();
            data.date_exported = millis;

            // get an ISO string and sanitize it for use in filenames
            const now = new Date();
            const isoNoMs = now.toISOString().split('.')[0];
            const safeIso = isoNoMs.replace(/:/g, '-');


            data[0].forms = Alpine.store('forms');

            data = data.filter((_, index) => !excluded.has(index));

            let json = JSON.stringify(data, null, 2);
            let blob = new Blob([json], { type: "text/json;charset=utf-8" });
            // let filename = `resque_${data[0].LastName ? data[0].LastName.toLowerCase() + "_" : ""}${millis}.json`;
            
            // build filename using ISO timestamp
            const namePart = data[0].LastName
            ? data[0].LastName.toLowerCase() + '_'
            : '';
            const filename = `resque_${namePart}${safeIso}.json`;

            let a = document.getElementById("download");
            a.innerText = filename;
            a.download = filename;
            a.href = (window.URL || window.webkitURL).createObjectURL(blob);

            a.click();
        }

        function getQueryConfig(params) {
            let queryConfig = {
                global: {},
            };

            params.forEach((value, key) => {
                if (key.includes(':')) {
                    const parts = key.split(':');

                    let location = queryConfig;

                    parts.forEach((part, index) => {
                        if (index === parts.length - 1) {
                            // Set the parameter
                            location[part] = value;
                        } else {
                            // Navigate into the correct location
                            location[part] = location[part] ?? {};
                            location = location[part];
                        }
                    })
                } else {
                    // Global config parameter
                    queryConfig.global[key] = value;
                }
            })

            return queryConfig;
        }

        const params = new URLSearchParams(window.location.search);

        Alpine.store('config').queryConfig = getQueryConfig(params);

        const mode = params.get("mode");
        const details = params.get("details") !== "false";

        function saveCurrentQueryConfig() {
            Alpine.store('data').input[0].queryConfig = Alpine.store('config').queryConfig;
        }

        // Load config
        fetch('./config/config.yaml').then(response => response.text()).then(text => {
            const config = jsyaml.load(text);

            Alpine.store('forms').config = config;

            return config;
        }).then((config) => {
            menu(config).then(m => {
                for (const key in m) {
                    if (m[key].elements) {
                        m[key].scoring = window.generateScoringRules(m[key].elements);
                        Alpine.store('indentations')[key] = window.getDepths(m[key].elements);
                    }
                    Alpine.store('forms')[key] = m[key];
                }

                Alpine.store('data').manualInit();
                Alpine.store('warnings').manualInit();

                if (!Alpine.store('data').input[0].queryConfig) {
                    // save query config
                    Alpine.store('data').input[0].queryConfig = Alpine.store('config').queryConfig;
                }

                Alpine.store('loaded', true);

                setTimeout(() => {
                    switchToTab(0);
                }, 0)

            }).then(() => {
                // Check config compatibility
                if (objectHash(Alpine.store('data').input[0].queryConfig) !== objectHash(Alpine.store('config').queryConfig)) {
                    showModal('config-incompatible-modal');
                }

                // Set background color from config
                document.documentElement.style.setProperty('--bg-color', Alpine.store('config').config.background_color);

                // Load instructions
                fetch('./config/instructions.md').then(response => response.text()).then(text => {
                    const converter = new showdown.Converter();
                    Alpine.store('forms').config.instructions = {};
                    Alpine.store('forms').config.instructions.md = text;
                    Alpine.store('forms').config.instructions.html = converter.makeHtml(text);
                });

                // Show instructions modal if configured
                if (Alpine.store('config').config.show_instruction) {
                    showInstructionsModal();
                }

                if (!Alpine.store('config').config.show_instruction && Alpine.store('data').input.length <= 1) {
                    //showInfoModal();
                    driver(tourMain).drive();
                }
            });
        });

    </script>
</body>

</html>